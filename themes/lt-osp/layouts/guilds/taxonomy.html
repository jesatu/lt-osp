{{ define "main" -}}
<h1>{{ .Title }}</h1>

{{- with .Menus.guilds }}
{{- if .HasChildren }}
<p>
    <strong>Guilds:</strong>
    {{- $len := len .Children }}
    {{- range $index, $e := .Children }}
    {{- if $index }}
    {{- if ge (add $index 1) $len }} and {{ else }}, {{ end }}
    {{- end }}
    {{ partial "guild-link" .Page }}
    {{- end }}
</p>
{{- end }}
{{- $parent := .Parent }}
{{- if $parent }}
{{- range $.Site.Menus.guilds }}
{{- if eq (default .Name .Identifier) $parent }}
<p>Back to <a href="{{ .URL }}" rel="parent">{{ .Title }}</a></p>
{{- end }}
{{- end }}
{{- end }}
{{- end }}

{{ .Content }}

<table class="skill-table">
    <thead>
        <tr>
            <th>Tier</th>
            <th colspan="42">{{ .Title }}</th>
        </tr>
    </thead>
    <tbody>
        {{- $skills := $.Site.GetPage "/skill" }}
        {{- $default_ladder := "none" }}
        {{- $ladder_count := 0}}
        {{- $scratch := newScratch }}

        {{- with where .Pages ".Params.ladder" "!=" nil }}
        {{- range $n, $group := .GroupByParam "ladder" }}
        {{- $scratch.SetInMap "ladders" $group.Key $n }}
        {{- $ladder_count = add $ladder_count 1 }}
        {{- end }}
        {{- end }}
        {{- $scratch.SetInMap "ladders" $default_ladder $ladder_count }}

        {{- $max_col := 0 }}
        {{- range .Pages.GroupByParam "tier" }}
        {{- $col := 0 }}
        {{- range .Pages.ByParam "ladder" }}
        {{- $ladder := .Params.ladder | default $default_ladder }}
        {{- $ladder_column := index ($scratch.Get "ladders") $ladder }}
        {{- if lt $col $ladder_column }}
        {{- range after 1 (seq $col $ladder_column) }}
        {{- $col = add $col 1 }}
        {{- end }}
        {{- end }}
        {{- $col = add $col 1 }}
        {{- end }}
        {{- if lt $max_col $col }}
        {{- $max_col = $col }}
        {{- end }}
        {{- end }}

        {{- $tier := 0 }}
        {{- range .Pages.GroupByParam "tier" }}
        {{- range after 1 (seq $tier (sub .Key 1)) }}
        <tr>
            <th>{{ . }}</th>
            <td colspan="{{ add $max_col 1 }}" class="no-skill"></td>
        </tr>
        {{- end }}
        {{- $col := 0 }}
        {{- $tier = .Key }}
        <tr>
            <th scope="row">{{ .Key }}</th>
            {{- range .Pages.ByParam "ladder" }}
            {{- $ladder := .Params.ladder | default $default_ladder }}
            {{- $ladder_column := index ($scratch.Get "ladders") $ladder }}
            {{- if lt $col $ladder_column }}
            {{- range after 1 (seq $col $ladder_column) }}
            <td class="no-skill"></td>
            {{- $col = add $col 1 }}
            {{- end }}
            {{- end }}
            <td>
                <a class="skill{{ if .Params.restricted }} restricted-skill{{ end }}{{ if .Params.replacement }} replacement-skill{{ end }}"
                    id="skill-{{ .UniqueID }}" href="{{ .Permalink }}"
                    {{ range .Params.prerequisites }}{{- with $skills.GetPage . }}
                    data-prerequisite="skill-{{ .UniqueID }}" {{ end }}{{ end }}>
                    {{ .Title }}
                </a>
            </td>
            {{- $col = add $col 1 }}
            {{- end }}

            {{- if le $col $max_col }}
            {{- range after 1 (seq $col $max_col) }}
            <td class="no-skill"></td>
            {{- end }}
            {{- end }}
        </tr>
        {{- end }}
        {{- range after 1 (seq $tier 5) }}
        <tr>
            <th>{{ . }}</th>
            <td colspan="{{ $max_col }}" class="no-skill"></td>
        </tr>
        {{- end }}
    </tbody>
</table>
<script src="/leader-line.min.js"></script>
<script type="text/javascript">
    'use strict';
    function onReady(callback) {
        if (
            document.readyState === "complete" ||
            (document.readyState !== "loading" && !document.documentElement.doScroll)
        ) {
            callback();
        } else {
            document.addEventListener("DOMContentLoaded", callback);
        }
    }
    onReady(function () {
        var lineColor = "#999";
        var options = {
            color: lineColor,
            dash: false,
            dropShadow: false,
            endPlugColor: lineColor,
            gradient: false,
            startPlugColor: lineColor
        };
        var highlightColor = "black";
        var connectionColor = "#777";
        var highlightShadow = "0 0 2px 1px rgba(0, 0, 0, .3)";
        var skills = document.getElementsByClassName("skill");
        Array.from(skills).forEach(skill => {
            skill.addEventListener('touchend', (evt) => {
                if (document.activeElement == evt.target) {
                    return;
                }
                evt.preventDefault();
                evt.target.focus();
            });

            if (!skill.dataset.prerequisite) {
                return;
            }
            var prerequisites = skill.dataset.prerequisite.split(";");
            prerequisites.forEach(prerequisiteId => {
                var prerequisite = document.getElementById(prerequisiteId);
                if (!prerequisite) {
                    return;
                }
                var line = new LeaderLine(prerequisite, skill, options);

                var reset = () => {
                    line.setOptions(options);
                    prerequisite.style.boxShadow = "none";
                    prerequisite.style.borderColor = null;
                    skill.style.boxShadow = "none";
                    skill.style.borderColor = null;
                };

                var onPrerequisiteFocus = () => {
                    line.setOptions({
                        startPlugColor: highlightColor,
                        endPlugColor: connectionColor,
                        gradient: true
                    });
                    prerequisite.style.boxShadow = highlightShadow;
                    skill.style.borderColor = connectionColor;
                };

                prerequisite.addEventListener('mouseenter', onPrerequisiteFocus);
                prerequisite.addEventListener('focus', onPrerequisiteFocus);
                prerequisite.addEventListener('mouseleave', reset);
                prerequisite.addEventListener('blur', reset);

                var onSkillFocus = () => {
                    line.setOptions({
                        startPlugColor: connectionColor,
                        endPlugColor: highlightColor,
                        gradient: true
                    });
                    prerequisite.style.borderColor = connectionColor;
                    skill.style.boxShadow = highlightShadow;
                };

                skill.addEventListener('mouseenter', onSkillFocus);
                skill.addEventListener('focus', onSkillFocus);
                skill.addEventListener('mouseleave', reset);
                skill.addEventListener('blur', reset);
            });
        });
    });
</script>
{{- end }}